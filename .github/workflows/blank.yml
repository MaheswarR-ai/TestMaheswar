# Archrock Playwright Regression Test Workflow
# 
# Email Recipients Configuration:
# - default: Reads DEFAULT_OUTLOOK_TO_EMAIL from .env file (e.g., aravi1504789@mastek.com)
# - project-specific: Reads PROJECT_OUTLOOK_TO_EMAIL from .env file (e.g., gokul1503875@mastek.com,kunal163486@mastek.com)
# - custom: User-defined email addresses (default: Gokul)

name: Archrock - Regression

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          

      custom_email:
        description: 'Custom email address (comma separated if multiple)'
        required: false
        type: string
        default: ''

env:
  ENV: dev
  

jobs:
  playwright-tests:
    timeout-minutes: 180
    runs-on: windows-latest

    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node 20.19+
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'

      - name: Set environment variables
        run: |
          $envSelected = "${{ github.event.inputs.environment }}"
          if ([string]::IsNullOrWhiteSpace($envSelected)) { $envSelected = 'dev' }

          "ENV=$envSelected" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "TEST_SUITE=ArchRock Regression" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Create file with environment-based secret
        env:
          DEV_ENVFILE: ${{ secrets.DEV_SECRET }}
        run: |
          Set-Content -Path ".env" -Value $env:DEV_ENVFILE -NoNewline -Encoding UTF8

      - name: Configure Email Recipients (Default + Project + Custom)
        env:
          DEFAULT_EMAILS: ${{ vars.DEFAULT_OUTLOOK_TO_EMAIL }}
          PROJECT_EMAILS: ${{ vars.PROJECT_OUTLOOK_TO_EMAIL }}
          CUSTOM_EMAILS: ${{ github.event.inputs.custom_email }}
        run: |
          $allEmails = @()

          # 1. Default emails from GitHub Variables
          if (-not [string]::IsNullOrWhiteSpace($env:DEFAULT_EMAILS)) {
            $allEmails += $env:DEFAULT_EMAILS.Split(',')
          }

          # 2. Project-specific emails from GitHub Variables
          if (-not [string]::IsNullOrWhiteSpace($env:PROJECT_EMAILS)) {
            $allEmails += $env:PROJECT_EMAILS.Split(',')
          }

          # 3. Custom emails from workflow input
          if (-not [string]::IsNullOrWhiteSpace($env:CUSTOM_EMAILS)) {
            $allEmails += $env:CUSTOM_EMAILS.Split(',')
          }

          # Clean, trim, remove empty & duplicates
          $finalEmailList = $allEmails |
            ForEach-Object { $_.Trim() } |
            Where-Object { -not [string]::IsNullOrWhiteSpace($_) } |
            Select-Object -Unique

          if ($finalEmailList.Count -eq 0) {
            throw "No email recipients configured."
          }

          $finalEmails = $finalEmailList -join ','

          Write-Host "Final Outlook recipients:"
          Write-Host $finalEmails
          Write-Host "Total recipients: $($finalEmailList.Count)"

          "OUTLOOK_TO_EMAIL=$finalEmails" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Clear Node Modules Cache
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\npm-cache
            node_modules
          key: clear-cache-${{ github.run_id }}

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install

      - name: Generate Results URL
        run: |
          $url = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          "LINK_TO_RESULTS_URL=$url" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Run Playwright tests
        env:
          LINK_TO_RESULTS_URL: ${{ env.LINK_TO_RESULTS_URL }}
        run: |
          switch ($env:ENV) {
            'dev' {
              npm run archRockDevRegression
            }
            default {
              throw "Unknown ENV '$env:ENV'"
            }
          }

      - name: Upload Playwright report
        if: ${{ always() && !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Send Email Notification
        if: ${{ always() && !cancelled() }}
        env:
          OUTLOOK_EMAIL: ${{ secrets.OUTLOOK_EMAIL }}
          OUTLOOK_PASSWORD: ${{ secrets.OUTLOOK_PASSWORD }}
          OUTLOOK_TO_EMAIL: ${{ env.OUTLOOK_TO_EMAIL }}
          LINK_TO_RESULTS_URL: ${{ env.LINK_TO_RESULTS_URL }}
          ENV_SELECTED: "${{ github.event.inputs.environment }} Reports"
        run: npm run sendEmail
