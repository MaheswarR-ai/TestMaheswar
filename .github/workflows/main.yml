name: Archrock - Regression

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - staging
          - production

      email_config:
        description: 'Email Recipient Configuration'
        required: true
        default: 'default'
        type: choice
        options:
          - default
          - project-specific
          - executor
          - custom

      custom_email:
        description: 'Custom email address (comma separated if multiple) - Only used when "custom" is selected'
        required: false
        type: string
        default: ''

env:
  ENV: dev

jobs:
  playwright-tests:
    timeout-minutes: 180
    runs-on: windows-latest

    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node 20.19+
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'

      - name: Set environment variables
        run: |
          $envSelected = "${{ github.event.inputs.environment }}"
          if ([string]::IsNullOrWhiteSpace($envSelected)) { $envSelected = 'dev' }

          # Set basic environment variables
          "ENV=$envSelected" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "TEST_SUITE=ArchRock Regression" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          # Email configuration based on user selection
          $emailConfig = "${{ github.event.inputs.email_config }}"
          
          # Default recipients (always available)
          $defaultEmails = "vishnu761060@mastek.com,anagha15391@mastek.com"
          
          # Project-specific recipients
          $projectEmails = "gokul1503875@mastek.com,kunal163486@mastek.com"
          
          # Executor email
          $executorEmail = "${{ github.actor }}@mastek.com"
          
          # Custom email from input
          $customEmail = "${{ github.event.inputs.custom_email }}"
          
          # Set recipients based on email_config selection
          switch ($emailConfig) {
            'default' {
              "EMAIL_RECIPIENTS_DEFAULT=$defaultEmails" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              "EMAIL_RECIPIENTS_PROJECT=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              "EMAIL_RECIPIENTS_EXECUTOR=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            }
            'project-specific' {
              "EMAIL_RECIPIENTS_DEFAULT=$defaultEmails" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              "EMAIL_RECIPIENTS_PROJECT=$projectEmails" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              "EMAIL_RECIPIENTS_EXECUTOR=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            }
            'executor' {
              "EMAIL_RECIPIENTS_DEFAULT=$defaultEmails" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              "EMAIL_RECIPIENTS_PROJECT=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              "EMAIL_RECIPIENTS_EXECUTOR=$executorEmail" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            }
            'custom' {
              "EMAIL_RECIPIENTS_DEFAULT=$defaultEmails" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              "EMAIL_RECIPIENTS_PROJECT=$customEmail" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              "EMAIL_RECIPIENTS_EXECUTOR=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            }
            default {
              "EMAIL_RECIPIENTS_DEFAULT=$defaultEmails" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              "EMAIL_RECIPIENTS_PROJECT=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              "EMAIL_RECIPIENTS_EXECUTOR=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            }
          }

      - name: Create file with environment-based secret
        env:
          DEV_ENVFILE: ${{ secrets.DEV_SECRET }}
          QA_ENVFILE:  ${{ secrets.QA_SECRET }}
        run: |
          $envName = $env:ENV
          switch ($envName) {
            'dev' { $secret = $env:DEV_ENVFILE }
            'qa'  { $secret = $env:QA_ENVFILE }
            default { throw "Unknown ENV: '$envName'" }
          }

          if (-not $secret) {
            throw "Empty secret for ENV '$envName'"
          }

          Set-Content -Path ".env" -Value $secret -NoNewline -Encoding UTF8

          if ((Get-Item ".env").Length -le 0) {
            throw "Empty .env file created for $envName"
          }

      - name: Clear Node Modules Cache
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\npm-cache
            node_modules
          key: clear-cache-${{ github.run_id }}

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install

      - name: Generate Results URL
        run: |
          $url = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          "LINK_TO_RESULTS_URL=$url" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Run Playwright tests
        env:
          LINK_TO_RESULTS_URL: ${{ env.LINK_TO_RESULTS_URL }}
        run: |
          if ($env:ENV -eq 'dev') {
            npm run archRockDevRegression
          } elseif ($env:ENV -eq 'qa') {
            npm run archRockQaRegression
          } else {
            throw "Unknown ENV '$env:ENV'"
          }

      - name: Upload Playwright report
        if: ${{ always() && !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Send Email Notification
        if: ${{ always() && !cancelled() }}
        env:
          OUTLOOK_EMAIL: ${{ secrets.OUTLOOK_EMAIL }}
          OUTLOOK_PASSWORD: ${{ secrets.OUTLOOK_PASSWORD }}
          EMAIL_RECIPIENTS_DEFAULT: ${{ env.EMAIL_RECIPIENTS_DEFAULT }}
          EMAIL_RECIPIENTS_PROJECT: ${{ env.EMAIL_RECIPIENTS_PROJECT }}
          EMAIL_RECIPIENTS_EXECUTOR: ${{ env.EMAIL_RECIPIENTS_EXECUTOR }}
          OUTLOOK_TO_EMAIL: ${{ env.OUTLOOK_TO_EMAIL }}
          LINK_TO_RESULTS_URL: ${{ env.LINK_TO_RESULTS_URL }}
          ENV_SELECTED: "${{ github.event.inputs.environment }} Reports"
        run: npm run sendEmail
