
# Archrock Playwright Regression Test Workflow
# 
# Email Recipients Configuration:
# - default: Standard QA team members
# - project-specific: Project stakeholders and managers
# - custom: User-defined email addresses

name: Archrock - Regression

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - staging
          - production

      email_config:
        description: 'Email Recipient Configuration'
        required: true
        default: 'default'
        type: choice
        options:
          - default
          - project-specific
          - custom

      custom_email:
        description: 'Custom email address (comma separated if multiple) - REQUIRED when "custom" is selected'
        required: false
        type: string
        default: ''

env:
  ENV: dev

jobs:
  playwright-tests:
    timeout-minutes: 180
    runs-on: windows-latest

    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node 20.19+
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'

      - name: Set environment variables
        run: |
          $envSelected = "${{ github.event.inputs.environment }}"
          if ([string]::IsNullOrWhiteSpace($envSelected)) { $envSelected = 'dev' }

          "ENV=$envSelected" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "TEST_SUITE=ArchRock Regression" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          # Configure email recipients based on selection
          $emailConfig = "${{ github.event.inputs.email_config }}"
          $finalEmailList = ""
          
          switch ($emailConfig) {
            'default' {
              # Default QA team members
              $finalEmailList = "vishnu761060@mastek.com,anagha15391@mastek.com,gokul1503875@mastek.com,kunal163486@mastek.com"
              Write-Host "Using default recipients"
            }
            'project-specific' {
              # Project stakeholders and managers
              $finalEmailList = "project.manager@mastek.com,tech.lead@mastek.com,stakeholder@mastek.com"
              Write-Host "Using project-specific recipients"
            }
            'custom' {
              # Custom email addresses provided by user
              $customEmails = "${{ github.event.inputs.custom_email }}"
              if ([string]::IsNullOrWhiteSpace($customEmails)) {
                throw "Custom email configuration selected but no email addresses provided. Please provide at least one email address."
              }
              # Clean and validate emails
              $emailList = $customEmails.Split(',') | ForEach-Object { $_.Trim() } | Where-Object { -not [string]::IsNullOrWhiteSpace($_) }
              if ($emailList.Count -eq 0) {
                throw "No valid email addresses found in custom email input. Please provide at least one valid email address."
              }
              $finalEmailList = $emailList -join ','
              Write-Host "Using custom recipients"
            }
            default {
              throw "Invalid email configuration: '$emailConfig'"
            }
          }
          
          # Validate at least one recipient exists
          if ([string]::IsNullOrWhiteSpace($finalEmailList)) {
            throw "No email recipients configured."
          }
          
          Write-Host "Final recipient list: $finalEmailList"
          $recipientCount = ($finalEmailList.Split(',')).Count
          Write-Host "Total recipients: $recipientCount"
          "OUTLOOK_TO_EMAIL=$finalEmailList" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Create file with environment-based secret
        env:
          DEV_ENVFILE: ${{ secrets.DEV_SECRET }}
          QA_ENVFILE:  ${{ secrets.QA_SECRET }}
          STAGING_ENVFILE: ${{ secrets.STAGING_SECRET }}
          PRODUCTION_ENVFILE: ${{ secrets.PRODUCTION_SECRET }}
        run: |
          $envName = $env:ENV
          switch ($envName) {
            'dev' { $secret = $env:DEV_ENVFILE }
            'qa'  { $secret = $env:QA_ENVFILE }
            'staging' { $secret = $env:STAGING_ENVFILE }
            'production' { $secret = $env:PRODUCTION_ENVFILE }
            default { throw "Unknown ENV: '$envName'" }
          }

          if (-not $secret) {
            throw "Empty secret for ENV '$envName'"
          }

          Set-Content -Path ".env" -Value $secret -NoNewline -Encoding UTF8

          if ((Get-Item ".env").Length -le 0) {
            throw "Empty .env file created for $envName"
          }

      - name: Clear Node Modules Cache
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\npm-cache
            node_modules
          key: clear-cache-${{ github.run_id }}

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install

      - name: Generate Results URL
        run: |
          $url = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          "LINK_TO_RESULTS_URL=$url" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Run Playwright tests
        env:
          LINK_TO_RESULTS_URL: ${{ env.LINK_TO_RESULTS_URL }}
        run: |
          switch ($env:ENV) {
            'dev' {
              npm run archRockDevRegression
            }
            'qa' {
              npm run archRockQaRegression
            }
            'staging' {
              npm run archRockStagingRegression
            }
            'production' {
              npm run archRockProductionRegression
            }
            default {
              throw "Unknown ENV '$env:ENV'"
            }
          }

      - name: Upload Playwright report
        if: ${{ always() && !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Send Email Notification
        if: ${{ always() && !cancelled() }}
        env:
          OUTLOOK_EMAIL: ${{ secrets.OUTLOOK_EMAIL }}
          OUTLOOK_PASSWORD: ${{ secrets.OUTLOOK_PASSWORD }}
          OUTLOOK_TO_EMAIL: ${{ env.OUTLOOK_TO_EMAIL }}
          LINK_TO_RESULTS_URL: ${{ env.LINK_TO_RESULTS_URL }}
          ENV_SELECTED: "${{ github.event.inputs.environment }} Reports"
        run: npm run sendEmail
